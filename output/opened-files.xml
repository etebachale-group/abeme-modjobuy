<Opened Files>
<File Name>
add_advance_payment_column.php
</File Name>
<File Content>
<?php
require_once 'includes/db.php';

try {
    // Agregar la columna advance_payment si no existe
    $pdo->exec("ALTER TABLE shipments ADD advance_payment DECIMAL(10,2) DEFAULT 0.00");
    echo "Columna advance_payment agregada correctamente.";
} catch (PDOException $e) {
    echo "Error: " . $e->getMessage();
}
?>
</File Content>
</Opened Files>
<Opened Files>
<File Name>
.git\COMMIT_EDITMSG
</File Name>
<File Content>

# Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
#
# On branch etebachalegroup
# Changes to be committed:
#	modified:   .clinerules/opened-files.md
#	modified:   .cursor/rules/opened-files.mdc
#	modified:   .roo/rules/opened-files.md
#	modified:   output/opened-files.xml
#

</File Content>
</Opened Files>
<Opened Files>
<File Name>
database.sql
</File Name>
<File Content>
CREATE DATABASE IF NOT EXISTS `abeme_modjobuy`;
USE `abeme_modjobuy`;

-- Tabla de usuarios
CREATE TABLE `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insertar usuario administrador
INSERT INTO `users` (`email`, `password`) 
VALUES ('djesis@abememodjobuy.com', '$2y$10$S.4V8uU1k5K0l2M3fXq0/.VqLd8i6wR7a0jZ1sYb3c4d5e6f7g8h9i');

-- Tabla de envíos


CREATE TABLE `shipments` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `code` VARCHAR(20) NOT NULL UNIQUE,
  `group_code` VARCHAR(20) NOT NULL,
  `sender_name` VARCHAR(100) NOT NULL,
  `sender_phone` VARCHAR(20) NOT NULL,
  `receiver_name` VARCHAR(100) NOT NULL,
  `receiver_phone` VARCHAR(20) NOT NULL,
  `product` VARCHAR(100) NOT NULL,
  `weight` DECIMAL(10,2) NOT NULL,
  `shipping_cost` DECIMAL(10,2) NOT NULL,
  `sale_price` DECIMAL(10,2) NOT NULL,
  `advance_payment` DECIMAL(10,2) DEFAULT 0.00,
  `profit` DECIMAL(10,2) NOT NULL,
  `ship_date` DATE NOT NULL,
  `est_date` DATE NOT NULL,
  `status` ENUM('pending', 'ontheway', 'arrived', 'delay', 'delivered') NOT NULL DEFAULT 'pending',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX `group_code_index` (`group_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabla de registro de acciones
CREATE TABLE `action_logs` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `shipment_id` INT NOT NULL,
  `action_type` VARCHAR(50) NOT NULL,
  `details` TEXT,
  `action_timestamp` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),
  FOREIGN KEY (`shipment_id`) REFERENCES `shipments`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Datos de ejemplo


INSERT INTO `shipments` (
  `code`, `group_code`, `sender_name`, `sender_phone`, `receiver_name`, `receiver_phone`, 
  `product`, `weight`, `shipping_cost`, `sale_price`, `advance_payment`, `profit`,
  `ship_date`, `est_date`, `status`
) VALUES
('ABM-2023-001', '01-15-23', 'Juan Perez', '600111222', 'Maria Gomez', '600333444', 'Electrónicos', 5.2, 80.00, 120.00, 0.00, 40.00, '2023-01-15', '2023-02-01', 'delivered'),
('ABM-2023-045', '05-10-23', 'Ana Lopez', '600555666', 'Pedro Martinez', '600777888', 'Ropa y accesorios', 3.8, 60.00, 85.00, 0.00, 25.00, '2023-05-10', '2023-05-25', 'ontheway'),
('ABM-2023-078', '07-22-23', 'Carlos Sanchez', '600999000', 'Laura Fernandez', '600123456', 'Documentos importantes', 0.5, 20.00, 35.00, 0.00, 15.00, '2023-07-22', '2023-07-30', 'pending'),
('ABM-2023-102', '08-05-23', 'Sofia Ramirez', '600789012', 'David Jimenez', '600456789', 'Herramientas', 15.7, 150.00, 210.00, 0.00, 60.00, '2023-08-05', '2023-08-20', 'delayed');
</File Content>
</Opened Files>
<Opened Files>
<File Name>
archived_shipments.php
</File Name>
<File Content>
<?php
require_once 'includes/db.php';
require_once 'includes/auth.php';
require_once 'includes/functions.php';

// Solo usuarios autenticados pueden ver esta página
requireAuth();

// Obtener los grupos archivados
function getArchivedGroups($pdo) {
    $stmt = $pdo->query("
        SELECT 
            s.group_code,
            DATE_FORMAT(s.ship_date, '%d/%m/%Y') as formatted_date,
            COUNT(*) as total_shipments,
            GROUP_CONCAT(s.code) as shipment_codes,
            MIN(s.ship_date) as group_date
        FROM shipments s
        INNER JOIN shipment_groups sg ON s.group_code = sg.group_code
        WHERE sg.is_archived = 1
        GROUP BY s.group_code, s.ship_date
        HAVING COUNT(*) = SUM(CASE WHEN s.status = 'delivered' THEN 1 ELSE 0 END)
        ORDER BY group_date DESC
    ");
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// Obtener los envíos de un grupo específico
function getArchivedShipmentsByGroup($pdo, $groupCode) {
    $stmt = $pdo->prepare("
        SELECT s.* 
        FROM shipments s
        INNER JOIN shipment_groups sg ON s.group_code = sg.group_code
        WHERE s.group_code = ? 
        AND sg.is_archived = 1 
        AND s.status = 'delivered'
        ORDER BY s.ship_date DESC
    ");
    $stmt->execute([$groupCode]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

$archivedGroups = getArchivedGroups($pdo);

// Incluir el encabezado
include 'includes/header.php';
?>

<div class="container">
    <h1 class="page-title">Envíos Archivados</h1>
    
    <div class="archived-groups">
        <?php foreach ($archivedGroups as $group): ?>
            <div class="shipment-group">
                <div class="group-header" id="group-<?php echo htmlspecialchars($group['group_code']); ?>">
                    <h2>
                        <span class="group-toggle" id="group-<?php echo htmlspecialchars($group['group_code']); ?>-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </span>
                        Grupo: <?php echo htmlspecialchars($group['group_code']); ?>
                        <span class="group-date"><?php echo htmlspecialchars($group['formatted_date']); ?></span>
                        <span class="total-shipments">Total: <?php echo $group['total_shipments']; ?> envíos</span>
                    </h2>
                </div>
                
                <div class="group-content hidden" id="group-<?php echo htmlspecialchars($group['group_code']); ?>-content">
                    <div class="shipments-grid">
                        <?php 
                        $shipments = getArchivedShipmentsByGroup($pdo, $group['group_code']);
                        foreach ($shipments as $shipment):
                        ?>
                        <div class="shipment-card">
                            <div class="shipment-header">
                                <span class="shipment-code"><?php echo htmlspecialchars($shipment['code']); ?></span>
                                <span class="status-indicator <?php echo htmlspecialchars(strtolower($shipment['status'])); ?>">
                                    <?php echo htmlspecialchars($shipment['status']); ?>
                                </span>
                            </div>
                            <div class="shipment-details">
                                <div class="detail-item">
                                    <label>Remitente:</label>
                                    <span><?php echo htmlspecialchars($shipment['sender_name']); ?></span>
                                </div>
                                <div class="detail-item">
                                    <label>Destinatario:</label>
                                    <span><?php echo htmlspecialchars($shipment['receiver_name']); ?></span>
                                </div>
                                <div class="detail-item">
                                    <label>Producto:</label>
                                    <span><?php echo htmlspecialchars($shipment['product']); ?></span>
                                </div>
                                <div class="detail-item">
                                    <label>Peso:</label>
                                    <span><?php echo htmlspecialchars($shipment['weight']); ?> kg</span>
                                </div>
                                <div class="detail-item">
                                    <label>Precio:</label>
                                    <span><?php echo number_format($shipment['sale_price'], 0, ',', '.'); ?> XAF</span>
                                </div>
                                <div class="detail-item">
                                    <label>Adelanto:</label>
                                    <span><?php echo number_format($shipment['advance_payment'], 2, ',', '.'); ?> XAF</span>
                                </div>
                            </div>
                            <div class="shipment-footer">
                                <span class="ship-date">Enviado: <?php echo htmlspecialchars($shipment['ship_date']); ?></span>
                            </div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para mostrar/ocultar los envíos de un grupo
    function toggleGroupShipments(groupCode) {
        const groupContent = document.querySelector(`#group-${groupCode}-content`);
        const groupHeader = document.querySelector(`#group-${groupCode}`);
        if (groupContent) {
            groupContent.classList.toggle('hidden');
            groupHeader.classList.toggle('active');
            const toggleIcon = document.querySelector(`#group-${groupCode}-toggle i`);
            if (toggleIcon) {
                toggleIcon.classList.toggle('fa-chevron-down');
                toggleIcon.classList.toggle('fa-chevron-up');
            }
            
            // Si el contenido está visible, hacemos scroll al grupo
            if (!groupContent.classList.contains('hidden')) {
                groupHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    // Agregar eventos click a los encabezados de grupo
    document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', function() {
            const groupCode = this.id.replace('group-', '');
            toggleGroupShipments(groupCode);
        });
    });

    // Auto expandir si hay un solo grupo
    const groups = document.querySelectorAll('.shipment-group');
    if (groups.length === 1) {
        const groupCode = groups[0].querySelector('.group-header').id.replace('group-', '');
        toggleGroupShipments(groupCode);
    }

    // Asegurarse de que el scroll horizontal funcione bien en dispositivos táctiles
    document.querySelectorAll('.shipments-grid').forEach(grid => {
        let isDown = false;
        let startX;
        let scrollLeft;

        grid.addEventListener('mousedown', (e) => {
            isDown = true;
            grid.classList.add('active');
            startX = e.pageX - grid.offsetLeft;
            scrollLeft = grid.scrollLeft;
        });

        grid.addEventListener('mouseleave', () => {
            isDown = false;
            grid.classList.remove('active');
        });

        grid.addEventListener('mouseup', () => {
            isDown = false;
            grid.classList.remove('active');
        });

        grid.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - grid.offsetLeft;
            const walk = (x - startX) * 2;
            grid.scrollLeft = scrollLeft - walk;
        });
    });
});
</script>

<?php include 'includes/footer.php'; ?>

</File Content>
</Opened Files>
<Opened Files>
<File Name>
expenses.php
</File Name>
<File Content>
<?php
require_once 'includes/db.php';
require_once 'includes/auth.php';
require_once 'includes/functions.php';

// Verificar que el usuario esté autenticado
requireAuth();

// Definir los socios
$partners = [
    'FERNANDO CHALE',
    'MARIA CARMEN NSUE',
    'GENEROSA ABEME',
    'MARIA ISABEL',
    'CAJA',
    'FONDOS DE SOCIOS'
];

// Procesar formulario de nuevo gasto
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_expense'])) {
    $description = $_POST['description'];
    $amount = floatval($_POST['amount']);
    $paid_by = $_POST['paid_by'];
    $date = $_POST['date'];
    $operation_type = $_POST['operation_type'] ?? 'subtract'; // Default to subtract if not set
    
    if (addExpense($pdo, $description, $amount, $paid_by, $date, $operation_type)) {
        $success = "Gasto registrado correctamente.";
    } else {
        $error = "Error al registrar el gasto.";
    }
    
    // Recargar la página para mostrar los cambios
    header("Location: expenses.php?success=" . urlencode($success));
    exit;
}

// Obtener gastos recientes
$expenses = getExpenses($pdo);

// Obtener beneficios de los socios
$partnerBenefits = getPartnerBenefits($pdo);

include 'includes/header.php';
?>

<div class="container">
    <h1>Gestión de Gastos</h1>
    
    <?php if (isset($_GET['success'])): ?>
        <div class="alert alert-success"><?php echo htmlspecialchars($_GET['success']); ?></div>
    <?php endif; ?>
    
    <?php if (!empty($success)): ?>
        <div class="alert alert-success"><?php echo $success; ?></div>
    <?php endif; ?>
    
    <?php if (!empty($error)): ?>
        <div class="alert alert-danger"><?php echo $error; ?></div>
    <?php endif; ?>
    
    <!-- Formulario para añadir gasto -->
    <div class="card">
        <h2>Añadir Nuevo Gasto</h2>
        <form method="POST">
            <input type="hidden" name="add_expense" value="1">
            
            <div class="form-group">
                <label>Tipo de Operación *</label><br>
                <input type="radio" id="operation_subtract" name="operation_type" value="subtract" checked>
                <label for="operation_subtract">Restar (Gasto)</label><br>
                <input type="radio" id="operation_add" name="operation_type" value="add">
                <label for="operation_add">Añadir (Ingreso)</label><br>
                <input type="radio" id="operation_adjust" name="operation_type" value="adjust">
                <label for="operation_adjust">Ajustes (Restar solo del total)</label>
            </div>
            
            <div class="form-group">
                <label for="description">Descripción del Gasto *</label>
                <input type="text" id="description" name="description" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="amount">Monto (XAF) *</label>
                <input type="number" id="amount" name="amount" class="form-control" step="0.01" min="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="paid_by">Pagado por *</label>
                <select id="paid_by" name="paid_by" class="form-control" required>
                    <option value="">Seleccione un socio</option>
                    <?php foreach ($partners as $partner): ?>
                        <option value="<?php echo htmlspecialchars($partner); ?>"><?php echo htmlspecialchars($partner); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="form-group">
                <label for="date">Fecha *</label>
                <input type="date" id="date" name="date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required>
            </div>
            
            <button type="submit" class="btn btn-primary">Registrar Gasto</button>
        </form>
    </div>
    
    <!-- Resumen de beneficios -->
    <div class="card">
        <h2>Resumen de Beneficios</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Socio</th>
                        <th>Gastos Totales</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($partnerBenefits as $benefit): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($benefit['partner_name']); ?></td>
                            <td>XAF <?php echo number_format($benefit['total_expenses'], 2, ',', '.'); ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Historial de gastos -->
    <div class="card">
        <h2>Historial de Gastos</h2>
        <div class="table-responsive">
            <?php if (empty($expenses)): ?>
                <p>No hay gastos registrados.</p>
            <?php else: ?>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo de Operación</th>
                            <th>Monto</th>
                            <th>Descripción</th>
                            <th>Socio (si aplica)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($expenses as $expense): ?>
                            <tr>
                                <td><?php echo htmlspecialchars($expense['date']); ?></td>
                                <td><?php echo htmlspecialchars(ucfirst($expense['operation_type'])); ?></td>
                                <td>XAF <?php echo number_format($expense['amount'], 2, ',', '.'); ?></td>
                                <td><?php echo htmlspecialchars($expense['description']); ?></td>
                                <td>
                                    <?php
                                    if (isset($expense['operation_type']) && $expense['operation_type'] === 'subtract') {
                                        echo htmlspecialchars($expense['paid_by']);
                                    } else {
                                        echo '-';
                                    }
                                    ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include 'includes/footer.php'; ?>
</File Content>
</Opened Files>
